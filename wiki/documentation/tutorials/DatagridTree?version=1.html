
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title> Datagrid Tree - libRocket</title>
<link rel="start" href="http://librocket.com/wiki"/><link rel="search" href="http://librocket.com/search"/><link rel="help" href="../../TracGuide.html"/><link rel="stylesheet" href="../../../chrome/common/css/trac.css" type="text/css"/><link rel="stylesheet" href="../../../chrome/common/css/wiki.css" type="text/css"/><link rel="icon" href="../../../chrome/site/trac.ico" type="image/x-icon"/><link rel="shortcut icon" href="../../../chrome/site/trac.ico" type="image/x-icon"/><link rel="alternate" href="DatagridTree%3Fversion=1&amp;format=txt" title="Plain Text" type="text/x-trac-wiki"/><style type="text/css">
</style>
<script type="text/javascript" src="../../../chrome/common/js/trac.js"></script>
<link rel="stylesheet" type="text/css" href="../../../chrome/site/style/base.css"></link>
<link rel="stylesheet" type="text/css" href="../../../chrome/site/style/content.css"></link>
<link rel="stylesheet" type="text/css" href="../../../chrome/site/style/discussion.css"></link>
<style>
		div.wiki img
		{
			display: block;
			margin-left: auto;
			margin-right: auto;
		}
	</style>
</head>
<body>
<div class="widthshell-width">
<div class="widthshell-minwidth">
<div class="widthshell-layout">
<div class="widthshell-container">
<div class="widthshell-content">
<div id="background">
<div style="float:right;width:160px;height:600px;margin-top:110px;margin-right:20px;">
<script type="text/javascript"><!--
                        google_ad_client = "pub-5872045433470541";
                        /* Default, Wide Skyscraper */
                        google_ad_slot = "3956485030";
                        google_ad_width = 160;
                        google_ad_height = 600;
                //-->
                </script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                </script>
</div>
<div class="shell">
<div class="stars">
<img id="star-1" src="../../../chrome/site/images/star-red-medium.gif" width="22px" height="22px" alt="Star"/>
<img id="star-2" src="../../../chrome/site/images/star-red-small.gif" width="13px" height="13px" alt="Star"/>
<img id="star-3" src="../../../chrome/site/images/star-red-small.gif" width="11px" height="11px" alt="Star"/>
<img id="star-4" src="../../../chrome/site/images/star-orange-small.gif" width="16px" height="16px" alt="Star"/>
<img id="star-5" src="../../../chrome/site/images/star-red-tiny.gif" width="7px" height="6px" alt="Star"/>
<img id="star-6" src="../../../chrome/site/images/star-red-tiny.gif" width="8px" height="7px" alt="Star"/>
<img id="star-7" src="../../../chrome/site/images/star-red-tiny.gif" width="7px" height="6px" alt="Star"/>
<img id="star-8" src="../../../chrome/site/images/star-red-big.gif" width="33px" height="33px" alt="Star"/>
<img id="star-9" src="../../../chrome/site/images/star-red-small.gif" width="13px" height="13px" alt="Star"/>
<img id="star-10" src="../../../chrome/site/images/star-red-tiny.gif" width="7px" height="6px" alt="Star"/>
<img id="star-11" src="../../../chrome/site/images/star-red-tiny.gif" width="8px" height="7px" alt="Star"/>
<img id="star-12" src="../../../chrome/site/images/star-red-tiny.gif" width="7px" height="6px" alt="Star"/>
</div>
<div id="header">
<a href="../../documentation.html"><img id="title" src="../../../chrome/site/images/title.gif" width="256px" height="49px" alt="Rocket"/></a>
<ul class="top-level-nav">
<li><a href="../../frontend/features.html">features.</a></li>

<li><a href="http://github.com/lloydw/librocket">download.</a></li>
<li><a href="http://forums.librocket.com">forums.</a></li>
<li><a href="../../documentation.html">developer.</a></li>
</ul>
<img id="trail" src="../../../chrome/site/images/trail-content.gif" width="72px" height="115px" alt="Rocket Trail"/>
<a href="../../documentation.html"><img id="rocket" src="../../../chrome/site/images/rocket-content.gif" width="126px" height="139px" alt="Rocket"/></a>
</div>
</div>
</div>
<div class="shell">
<div id="banner">
<div class="stars">
<img id="star-13" src="../../../chrome/site/images/star-black-big.gif" width="49px" height="50px" alt="Star"/>
<img id="star-14" src="../../../chrome/site/images/star-black-medium.gif" width="23px" height="23px" alt="Star"/>
<img id="star-15" src="../../../chrome/site/images/star-black-small.gif" width="14px" height="14px" alt="Star"/>
<img id="star-16" src="../../../chrome/site/images/star-black-small.gif" width="14px" height="14px" alt="Star"/>
<img id="star-17" src="../../../chrome/site/images/star-black-medium.gif" width="21px" height="21px" alt="Star"/>
<img id="star-18" src="../../../chrome/site/images/star-black-tiny.gif" width="13px" height="13px" alt="Star"/>
<img id="star-19" src="../../../chrome/site/images/star-black-tiny.gif" width="9px" height="9px" alt="Star"/>
<img id="star-20" src="../../../chrome/site/images/star-black-tiny.gif" width="10px" height="10px" alt="Star"/>
<img id="star-21" src="../../../chrome/site/images/star-black-medium.gif" width="21px" height="21px" alt="Star"/>
<img id="star-22" src="../../../chrome/site/images/star-black-small.gif" width="14px" height="14px" alt="Star"/>
<img id="star-23" src="../../../chrome/site/images/star-black-small.gif" width="13px" height="13px" alt="Star"/>
</div>
<img id="banner-bottom-left" src="../../../chrome/site/images/banner-bottom-left.gif" width="20px" height="19px" alt="Bottom left banner image"/>
<img id="banner-bottom-right" src="../../../chrome/site/images/banner-bottom-right.gif" width="20px" height="19px" alt="Bottom right banner image"/>
<div id="login"><a href="http://librocket.com/login">Login</a> | <a "http://librocket.com/wiki/documentation/tutorials/href">Register</a></div>
<div id="breadcrumbs">
<a href="../../documentation.html">documentation</a> <strong>&#8249;</strong> <a href="../tutorials.1.html">tutorials</a> <strong>&#8249;</strong> <a href="DatagridTree.html">DatagridTree</a></div>
<div id="title"> Datagrid Tree</div>
<div id="second-level-nav">
<span class="nav-item active"><a href="../../documentation.html">Documentation</a></span>
<span class="nav-item"><a accesskey="4" href="http://librocket.com/search">Search</a></span>
</div>
</div>
<div id="content-container">
<div id="content" class="wiki">
<table id="info" summary="Revision info"><tbody><tr>
<th scope="col">
Version 1 (modified by robertc, 10 years ago)
</th></tr><tr>
<td class="message">--</td>
</tr>
</tbody></table>
<div class="wikipage">
<div id="searchable"><p>
<div class="wiki-toc"><h4>Contents</h4><ol><li><a href="DatagridTree%3Fversion=1.html#DatagridTreeTutorial">Datagrid Tree Tutorial</a><ol><li><a href="DatagridTree%3Fversion=1.html#Step1:ThePlan">Step 1: The Plan</a><ol><li><a href="DatagridTree%3Fversion=1.html#Treestructure">Tree structure</a></li><li>
<a href="DatagridTree%3Fversion=1.html#TherevisedHighScores">The revised HighScores</a></li></ol><li><a href="DatagridTree%3Fversion=1.html#Step2:ImprovingtheDataSource">Step 2: Improving the Data Source</a><ol><li><a href="DatagridTree%3Fversion=1.html#Specifyingthechilddatasource">Specifying the child data source</a></li><li>
<a href="DatagridTree%3Fversion=1.html#Addingtheplayertables">Adding the player tables</a></li></ol><li><a href="DatagridTree%3Fversion=1.html#Step3:Addingtheexpandbutton">Step 3 : Adding the expand button</a><ol><li><a href="DatagridTree%3Fversion=1.html#Addingthecolumn">Adding the column</a></li><li>
<a href="DatagridTree%3Fversion=1.html#Creatingthedataformatter">Creating the data formatter</a></li></ol><li><a href="DatagridTree%3Fversion=1.html#Step4:Styling">Step 4: Styling</a></li></ol></li></ol></div>
</p>
<h1 id="DatagridTreeTutorial">Datagrid Tree Tutorial</h1>
<p>
This tutorial expects that you've got a solid grounding in C++ and know the basics of RML and RCSS, and know the basics of datagrids (ie, completed the first <a class="wiki" href="Datagrid.html">datagrid tutorial</a>.)
</p>
<h2 id="Step1:ThePlan">Step 1: The Plan</h2>
<p>
So we've got a pretty nice high scores chart, but we want to add some pep. One way to do that would be to show how many of each type of alien each person on the chart has destroyed. If we had this much information for everyone shown all the time there we would get info overload, so we'll develop it so the user can expand each row of the chart and see the kills that way.
</p>
<h3 id="Treestructure">Tree structure</h3>
<p>
Each row in a datagrid has the ability to possess child rows - each of which can also have child rows, and so on. This is specified by the data source returning the name of the data source and table that the row fetches its children from - in the same way that a datagrid definition specifies the data source and table to fetch the root rows from.
</p>
<p>
A row's child rows are displayed directly underneath the row itself. By default a row starts with its child rows hidden, so you'll only see the top level rows when you view a datagrid for the first time. Fortunately there are a few tools that you can use to automatically add tree functionality to your datagrid. More on these later - next, let's look at the changes we've made to the existing datagrid tutorial:
</p>
<h3 id="TherevisedHighScores">The revised HighScores</h3>
<p>
Take a look at the HighScores class and see its changes from the first datagrid tutorial. The changes to the definition are the addition of the NUM_ALIEN_TYPES variable and the addition of the alien_kills variable to the SubmitScore function and the Score struct:
</p>
<pre class="wiki">const int NUM_ALIEN_TYPES = 3;

...

void SubmitScore(const EMP::Core::String&amp; name, const EMP::Core::Colourb&amp; colour, int wave, int score, int alien_kills[]);

...

struct Score
{
	EMP::Core::String name;
	EMP::Core::Colourb colour;
	int score;
	int wave;

	int alien_kills[NUM_ALIEN_TYPES];
};
</pre><p>
The alien_kills array stores how many of each type of alien the player killed to get his score. This is what we'll be basing the new part of the chart from. The cpp file contains changes to the SubmitScore and LoadScores function to reflect the new data on the alien kills.
</p>
<h2 id="Step2:ImprovingtheDataSource">Step 2: Improving the Data Source</h2>
<h3 id="Specifyingthechilddatasource">Specifying the child data source</h3>
<p>
So first of all we need to make the data source aware of the child rows. The best way to do this is to add more tables to the HighScores data source: one table for each row. So in the GetRow function, when we're checking what the columns are, we need to add one more check in - the check for the child data source. I added this code in after the "wave" check:
</p>
<pre class="wiki">else if (columns[i] == EMP::Core::DataSource::CHILD_SOURCE)
{
	row.push_back(EMP::Core::String(24, "high_scores.player_%d", row_index));
}
</pre><p>
This tells the calling datagrid that this row's child data source is "high_scores" (the same source that we're editing) and the table is called player_X. So now at the top of the GetRow and GetNumRows functions we now have to check for that table as well.
</p>
<p>
You may be wondering where the EMP::Core::DataSource::CHILD_SOURCE variable came from! It's one of three predefined variables that can be used as column names and in the fields attribute in the col definition. The other two are DEPTH and NUM_CHILDREN. DEPTH returns the depth of the row and can be used by data formatters to draw something different for each row. NUM_CHILDREN returns the number of children under each row, and is most often used to know when to draw a '+' button to expand the row. We'll be using NUM_CHILDREN later.
</p>
<h3 id="Addingtheplayertables">Adding the player tables</h3>
<p>
So now we need to add the extra tables into the data source. This can be done by adding an else statement in the GetRow and GetNumRows functions to catch all calls to tables that aren't "scores", then reading off the name which row it is exactly that's being queried.
</p>
<pre class="wiki">else
{
	int player_index;
	if (sscanf(table.CString(), "player_%d", &amp;player_index) == 1)
	{
		// Code goes in here.
	}
}
</pre><p>
For the GetNumRows function I wanted it only to return the number of alien types with actual kills, so if the player hasn't killed any of a certain type then we don't return that. Then is the code I ended up with:
</p>
<pre class="wiki">int player_index;
if (sscanf(table.CString(), "player_%d", &amp;player_index) == 1)
{
	int num_alien_types = 0;
	for (int i = 0; i &lt; NUM_ALIEN_TYPES; i++)
	{
		if (scores[player_index].alien_kills[i] &gt; 0)
		{
			num_alien_types++;
		}
	}
	return num_alien_types;
}
</pre><p>
The GetRows function is, of course, a bit more complicated. In the "name" column we want it to display the name of the alien vessel. In the "score" column we can put the score of the alien that was destroyed. Under the "colour" column we'll want to display the image of the bad guy - we can upgrade the defender decorator to handle this. And finally the "wave" column will show how many of the little blighters the player managed to frag. Here's my code:
</p>
<pre class="wiki">else
{
	int player_index;
	if (sscanf(table.CString(), "player_%d", &amp;player_index) == 1)
	{
		// Translate the row_index to the actual index into the alien_kills array - as there might be gaps in the
		// array we may have to skip those entries.
		int alien_kills_array_index = row_index;
		for (int i = 0; i &lt; NUM_ALIEN_TYPES &amp;&amp; i &lt;= alien_kills_array_index; i++)
		{
			if (scores[row_index].alien_kills[i] == 0)
				alien_kills_array_index++;
		}

		for (size_t i = 0; i &lt; columns.size(); i++)
		{
			if (columns[i] == "name")
			{
				row.push_back(ALIEN_NAMES[row_index]);
			}
			else if (columns[i] == "score")
			{
				row.push_back(EMP::Core::String(8, "%d", ALIEN_SCORES[row_index]));
			}
			else if (columns[i] == "colour")
			{
				EMP::Core::String colour_string;
				EMP::Core::TypeConverter&lt; EMP::Core::Colourb, EMP::Core::String &gt;::Convert(EMP::Core::Colourb(255, 255, 255), colour_string);
				row.push_back(colour_string);
			}
			else if (columns[i] == "wave")
			{
				int num_kills = scores[player_index].alien_kills[alien_kills_array_index];
				if (num_kills == 1)
					row.push_back(EMP::Core::String("1 kill"));
				else
					row.push_back(EMP::Core::String(16, "%d kills", num_kills));
			}
		}
	}
}
</pre><p>
Run this and you should see: nothing different. All the rows are there, just hidden away, and we've no way to expand the rows!
</p>
<h2 id="Step3:Addingtheexpandbutton">Step 3 : Adding the expand button</h2>
<p>
We need to make a new column in the datagrid, and into that column add a button if the row has any child rows.
</p>
<h3 id="Addingthecolumn">Adding the column</h3>
<p>
Open the tutorial.rml file in the data folder, and look at where the datagrid is defined. We have to squeeze an extra col element in there. We won't give this column a title, and it'll have a formatter to create the button we need. The only bit of information that the formatter needs is how many child rows the row has - if it has 0 children then we don't create a button, 1 or more children then we do create it. So it should look something like this:
</p>
<pre class="wiki">&lt;datagrid source="high_scores.scores"&gt;
	&lt;col fields="#num_children" formatter="expand_button" width="10%"&gt;&lt;/col&gt;
	&lt;col fields="name" width="30%"&gt;Pilot:&lt;/col&gt;
	&lt;col fields="colour" formatter="ship" width="20%"&gt;Ship:&lt;/col&gt;
	&lt;col fields="wave" width="20%"&gt;Wave:&lt;/col&gt;
	&lt;col fields="score" width="20%"&gt;Score:&lt;/col&gt;
&lt;/datagrid&gt;
</pre><p>
Of course we've no formatter called "expand_button", we'll have to create that later. The "#num_children" field corresponds to the EMP::Core::DataSource::NUM_CHILDREN string - we use this to ask the data source about its number of children. I took 10% width out of the Pilot column to make room. So, fire this up and see what we get:
</p>
<p>
<img src="../../../attachment/wiki/documentation/tutorials/DatagridTree/tutorial_datagrid_tree_1.gif%3Fformat=raw"/>
</p>
<p>
As you can see, we haven't got our "expand_button" formatter yet so it falls back to displaying the raw text output, in this case the number of children.
</p>
<h3 id="Creatingthedataformatter">Creating the data formatter</h3>
<p>
Naturally, the next step is to create the data formatter! This one is pretty simple - all it does it read the first entry of the raw_data array to see how many children there are. If there is at least one child, then we return a &lt;datagridexpand&gt; element, otherwise we return nothing:
</p>
<pre class="wiki">void ExpandButtonFormatter::FormatData(EMP::Core::String&amp; formatted_data, const EMP::Core::StringList&amp; raw_data)
{
	// Data format:
	// raw_data[0] is the number of children that this row has. 0 means no button, more than 0 mean a button.

	int num_children = 0;
	EMP::Core::TypeConverter&lt; EMP::Core::String, int &gt;::Convert(raw_data[0], num_children);
	
	if (num_children &gt; 0)
	{
		formatted_data = "&lt;datagridexpand /&gt;";
	}
	else
	{
		formatted_data = "";
	}
}
</pre><p>
The datagridexpand element is an element that listens to the onclick events and toggles the visibility of the child rows of its parent row. In the RML there's been styling added to make it look like a +/- button - you'll have to style one yourself just like a button if you plan on using trees in your own application.
</p>
<p>
Don't forget to call the formatter the right name, and to instance the formatter in main.cpp. Once that's done, fire it up and you'll see the expand buttons beside each row, and be able to expand the child rows:
</p>
<p>
<img src="../../../attachment/wiki/documentation/tutorials/DatagridTree/tutorial_datagrid_tree_2.gif%3Fformat=raw"/>
</p>
<h2 id="Step4:Styling">Step 4: Styling</h2>
<p>
All that remains is upgrading the defender decorator to support displaying different images. The project's already been set up in a way so that if we give the defender element the classes of alien_1, alien_2 or alien_3 then it'll display with the image of that alien instead of the defender. We should probably rename that element too, as it's a bit of misnomer now, but we'll leave that till later. :) If we make a new field - type - and pass that into the defender decorator as well, we can get then defender to allocate the right class to get it to display the corresponding image. So, in tutorial.rml:
</p>
<pre class="wiki">&lt;col fields="colour,type" formatter="ship" width="20%"&gt;Ship:&lt;/col&gt;
</pre><p>
And in the GetRow function in HighScores.cpp, for the "scores" table, right after the "colour" check:
</p>
<pre class="wiki">else if (columns[i] == "type")
{
	rows.push_back("0");
}
</pre><p>
And in the same function, for the "player_X" table:
</p>
<pre class="wiki">else if (columns[i] == "type")
{
	row.push_back(EMP::Core::String(8, "%d", alien_kills_array_index + 1));
}
</pre><p>
And then finally the formatter needs updating to use the new field we're sending through to it:
</p>
<pre class="wiki">void HighScoresShipFormatter::FormatData(EMP::Core::String&amp; formatted_data, const EMP::Core::StringList&amp; raw_data)
{
	// Data format:
	// raw_data[0] is the colour, in "%d, %d, %d, %d" format.
	// raw_data[1] is the type. 0 means a defender, else N means alien type N.

	EMP::Core::Colourb ship_colour;
	EMP::Core::TypeConverter&lt; EMP::Core::String, EMP::Core::Colourb &gt;::Convert(raw_data[0], ship_colour);
	EMP::Core::String colour_string(32, "%d,%d,%d", ship_colour.red, ship_colour.green, ship_colour.blue);

	int ship_type;
	EMP::Core::TypeConverter&lt; EMP::Core::String, int &gt;::Convert(raw_data[1], ship_type);
	EMP::Core::String class_string = "";
	if (ship_type &gt; 0)
	{
		class_string = EMP::Core::String(32, "class=\"alien_%d\"", ship_type);
	}

	formatted_data = "&lt;defender " + class_string + " style=\"color: rgb(" + colour_string + ");\" /&gt;";
}
</pre><p>
Which gives us the following:
</p>
<p>
<img src="../../../attachment/wiki/documentation/tutorials/DatagridTree/tutorial_datagrid_tree_3.gif%3Fformat=raw"/>
</p>
</div>
</div>
<script type="text/javascript">
   addHeadingLinks(document.getElementById("searchable"), "Link to this section");
  </script>
</div>
</div>
</div>
<div id="footer">
<a id="tracpowered" href="http://trac.edgewall.org/">
<img src="../../../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered"/>
</a>
<p class="left">
Powered by <a href="http://librocket.com/about"><strong>Trac </strong></a><br/>By <a href="http://www.edgewall.org/">Edgewall Software</a>.
</p>
<p id="copyright" class="left clear">
Copyright &copy; 2007-2010 Code Point Ltd, Shift Technology Ltd.
</p>
<ul class="top-level-nav">
<li><a href="../../frontend/features.html">features.</a></li>
<li><a "http://librocket.com/wiki/documentation/tutorials/href">download.</a></li>
<li><a href="http://forums.librocket.com">forums.</a></li>
<li><a href="../../documentation.html">developer.</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
<script type="text/javascript">
    var pageTracker = _gat._getTracker("UA-3379591-1");
    pageTracker._initData();
    pageTracker._trackPageview();
    </script>
</body>
</html>
