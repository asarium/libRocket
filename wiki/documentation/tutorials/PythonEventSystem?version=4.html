
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title> Python Event System - libRocket</title>
<link rel="start" href="http://librocket.com/wiki"/><link rel="search" href="http://librocket.com/search"/><link rel="help" href="../../TracGuide.html"/><link rel="stylesheet" href="../../../chrome/common/css/trac.css" type="text/css"/><link rel="stylesheet" href="../../../chrome/common/css/wiki.css" type="text/css"/><link rel="icon" href="../../../chrome/site/trac.ico" type="image/x-icon"/><link rel="shortcut icon" href="../../../chrome/site/trac.ico" type="image/x-icon"/><link rel="alternate" href="PythonEventSystem%3Fversion=4&amp;format=txt" title="Plain Text" type="text/x-trac-wiki"/><style type="text/css">
</style>
<script type="text/javascript" src="../../../chrome/common/js/trac.js"></script>
<link rel="stylesheet" type="text/css" href="../../../chrome/site/style/base.css"></link>
<link rel="stylesheet" type="text/css" href="../../../chrome/site/style/content.css"></link>
<link rel="stylesheet" type="text/css" href="../../../chrome/site/style/discussion.css"></link>
<style>
		div.wiki img
		{
			display: block;
			margin-left: auto;
			margin-right: auto;
		}
	</style>
</head>
<body>
<div class="widthshell-width">
<div class="widthshell-minwidth">
<div class="widthshell-layout">
<div class="widthshell-container">
<div class="widthshell-content">
<div id="background">
<div style="float:right;width:160px;height:600px;margin-top:110px;margin-right:20px;">
<script type="text/javascript"><!--
                        google_ad_client = "pub-5872045433470541";
                        /* Default, Wide Skyscraper */
                        google_ad_slot = "3956485030";
                        google_ad_width = 160;
                        google_ad_height = 600;
                //-->
                </script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                </script>
</div>
<div class="shell">
<div class="stars">
<img id="star-1" src="../../../chrome/site/images/star-red-medium.gif" width="22px" height="22px" alt="Star"/>
<img id="star-2" src="../../../chrome/site/images/star-red-small.gif" width="13px" height="13px" alt="Star"/>
<img id="star-3" src="../../../chrome/site/images/star-red-small.gif" width="11px" height="11px" alt="Star"/>
<img id="star-4" src="../../../chrome/site/images/star-orange-small.gif" width="16px" height="16px" alt="Star"/>
<img id="star-5" src="../../../chrome/site/images/star-red-tiny.gif" width="7px" height="6px" alt="Star"/>
<img id="star-6" src="../../../chrome/site/images/star-red-tiny.gif" width="8px" height="7px" alt="Star"/>
<img id="star-7" src="../../../chrome/site/images/star-red-tiny.gif" width="7px" height="6px" alt="Star"/>
<img id="star-8" src="../../../chrome/site/images/star-red-big.gif" width="33px" height="33px" alt="Star"/>
<img id="star-9" src="../../../chrome/site/images/star-red-small.gif" width="13px" height="13px" alt="Star"/>
<img id="star-10" src="../../../chrome/site/images/star-red-tiny.gif" width="7px" height="6px" alt="Star"/>
<img id="star-11" src="../../../chrome/site/images/star-red-tiny.gif" width="8px" height="7px" alt="Star"/>
<img id="star-12" src="../../../chrome/site/images/star-red-tiny.gif" width="7px" height="6px" alt="Star"/>
</div>
<div id="header">
<a href="../../documentation.html"><img id="title" src="../../../chrome/site/images/title.gif" width="256px" height="49px" alt="Rocket"/></a>
<ul class="top-level-nav">
<li><a href="../../frontend/features.html">features.</a></li>

<li><a href="http://github.com/lloydw/librocket">download.</a></li>
<li><a href="http://forums.librocket.com">forums.</a></li>
<li><a href="../../documentation.html">developer.</a></li>
</ul>
<img id="trail" src="../../../chrome/site/images/trail-content.gif" width="72px" height="115px" alt="Rocket Trail"/>
<a href="../../documentation.html"><img id="rocket" src="../../../chrome/site/images/rocket-content.gif" width="126px" height="139px" alt="Rocket"/></a>
</div>
</div>
</div>
<div class="shell">
<div id="banner">
<div class="stars">
<img id="star-13" src="../../../chrome/site/images/star-black-big.gif" width="49px" height="50px" alt="Star"/>
<img id="star-14" src="../../../chrome/site/images/star-black-medium.gif" width="23px" height="23px" alt="Star"/>
<img id="star-15" src="../../../chrome/site/images/star-black-small.gif" width="14px" height="14px" alt="Star"/>
<img id="star-16" src="../../../chrome/site/images/star-black-small.gif" width="14px" height="14px" alt="Star"/>
<img id="star-17" src="../../../chrome/site/images/star-black-medium.gif" width="21px" height="21px" alt="Star"/>
<img id="star-18" src="../../../chrome/site/images/star-black-tiny.gif" width="13px" height="13px" alt="Star"/>
<img id="star-19" src="../../../chrome/site/images/star-black-tiny.gif" width="9px" height="9px" alt="Star"/>
<img id="star-20" src="../../../chrome/site/images/star-black-tiny.gif" width="10px" height="10px" alt="Star"/>
<img id="star-21" src="../../../chrome/site/images/star-black-medium.gif" width="21px" height="21px" alt="Star"/>
<img id="star-22" src="../../../chrome/site/images/star-black-small.gif" width="14px" height="14px" alt="Star"/>
<img id="star-23" src="../../../chrome/site/images/star-black-small.gif" width="13px" height="13px" alt="Star"/>
</div>
<img id="banner-bottom-left" src="../../../chrome/site/images/banner-bottom-left.gif" width="20px" height="19px" alt="Bottom left banner image"/>
<img id="banner-bottom-right" src="../../../chrome/site/images/banner-bottom-right.gif" width="20px" height="19px" alt="Bottom right banner image"/>
<div id="login"><a href="http://librocket.com/login">Login</a> | <a "http://librocket.com/wiki/documentation/tutorials/href">Register</a></div>
<div id="breadcrumbs">
<a href="../../documentation.html">documentation</a> <strong>&#8249;</strong> <a href="../tutorials.1.html">tutorials</a> <strong>&#8249;</strong> <a href="PythonEventSystem.html">PythonEventSystem</a></div>
<div id="title"> Python Event System</div>
<div id="second-level-nav">
<span class="nav-item active"><a href="../../documentation.html">Documentation</a></span>
<span class="nav-item"><a accesskey="4" href="http://librocket.com/search">Search</a></span>
</div>
</div>
<div id="content-container">
<div id="content" class="wiki">
<table id="info" summary="Revision info"><tbody><tr>
<th scope="col">
Version 4 (modified by lloydw, 10 years ago)
</th></tr><tr>
<td class="message">--</td>
</tr>
</tbody></table>
<div class="wikipage">
<div id="searchable"><p>
<div class="wiki-toc"><ol><li><a href="PythonEventSystem%3Fversion=4.html#PythonEventTutorial">Python Event Tutorial</a><ol><li><a href="PythonEventSystem%3Fversion=4.html#Step1:SettingupthePythonenvironment">Step 1: Setting up the Python environment</a></li><li>
<a href="PythonEventSystem%3Fversion=4.html#Step2:ReplacingtheEventSystem">Step 2: Replacing the Event System</a></li><li>
<a href="PythonEventSystem%3Fversion=4.html#Step3:ExposingGameFunctions">Step 3: Exposing Game Functions</a></li><li>
<a href="PythonEventSystem%3Fversion=4.html#Step4:CustomElements">Step 4: Custom Elements</a></li><li>
<a href="PythonEventSystem%3Fversion=4.html#Step5:Keyandendgamebindings">Step 5: Key and end game bindings</a></li><li>
<a href="PythonEventSystem%3Fversion=4.html#Step6:PythonDataFormatters">Step 6: Python Data Formatters</a></li></ol></li></ol></div>
</p>
<h1 id="PythonEventTutorial">Python Event Tutorial</h1>
<p>
The Python interface to Rocket exposes a DOM API in a very similar way to Javascript. Python code can be attached to any event in the RML definition which is turn can dynamically update any part of the document including open other documents. Full source code to the final PyInvaders application can be found in the samples folder once the Python plugin has been installed.
</p>
<h2 id="Step1:SettingupthePythonenvironment">Step 1: Setting up the Python environment</h2>
<p>
The first thing we need to do is initialise python in our application, once we have done this we can start executing scripts. We're going to make a PythonInterface class that will hide all the python intricacies.
</p>
<pre class="wiki">/**
	Creates and maintains the python interface to Invaders.
 */

class PythonInterface
{
public:
    static bool Initialise();
    static void Shutdown();

private:
    PythonInterface();
    ~PythonInterface();
};

</pre><p>
We then implement these methods.
</p>
<p>
<i>NOTE: Its a good idea to forcibly import the rocket Python module, this ensures all boost bindings have been done and that you can proceed to expose your own classes that rely on these bindings having taken place.</i>
</p>
<p>
<i>NOTE: For more information Python initialisation and shutdown please see the Python documentation at <a class="ext-link" href="http://docs.python.org"><span class="icon">http://docs.python.org</span></a></i>
</p>
<pre class="wiki">bool PythonInterface::Initialise()
{
    Py_Initialize();

    // Pull in the rocket python module.
    Py_XDECREF(PyImport_ImportModule("rocket"));
    return true;
}

void PythonInterface::Shutdown()
{
    Py_Finalize();
}
</pre><p>
PythonInterface::Initialise should be called before rocket is initialised, this ensures the Python bindings are available when rocket starts up.
</p>
<p>
PythonInterface::Shutdown should be called after you've released all contexts but before you call Rocket::Shutdown(). This ensures all python objects are released before rocket does its final cleanup.
</p>
<p>
At this point you'll need to add the relevant Python and Boost::Python build paths to your project and then compile and link your project.
</p>
<h2 id="Step2:ReplacingtheEventSystem">Step 2: Replacing the Event System</h2>
<p>
We can now completely remove the exiting event system from <i>RocketInvaders</i> as the Python bindings will do all the EventManagement for us. Remove all source and header files that begin with Event. You'll also need to comment out some code in GameElement.cpp and Game.cpp that call the EventManager directly. We'll get back to those later.
</p>
<p>
Also remove all the EventManager initialisation from main.cpp as we'll replace it with a new Python script. I suggest you name it <i>autoexec.py</i> and place it in a <i>python</i> subfolder. It should look something like this:
</p>
<pre class="wiki">import rocket

context = rocket.GetContext('main')
context.LoadDocument('data/background.rml').Show()
context.LoadDocument('data/main_menu.rml').Show()
</pre><p>
To run this script, we simply need to import it at application start up. Add an import helper to the PythonInterface and call it just before the main shell loop.
</p>
<pre class="wiki">bool PythonInterface::Import(const EMP::Core::String&amp; name)
{
    PyObject* module = PyImport_ImportModule(name.CString());
    if (!module)
    {
        PyErr_Print();
        return false;
    }

    Py_DECREF(module);
    return true;
}
</pre><pre class="wiki">PythonInterface::Import("autoexec");
Shell::EventLoop(GameLoop);
</pre><p>
At this point the <i>RocketInvaders</i> will now run, however you'll get a script import error because <i>autoexec</i> cannot be found. To fix this we'll need to add the <i>python</i> folder to our Python search path.
</p>
<p>
<i>NOTE: On Windows this error will go to stdout, which will not be visible. I suggest you grab a copy of DoAllocConsole() from the pyinvaders sample and drop it into your project. Call DoAllocConsole() at the start of your main function and you'll get a console for reading python error messages.</i>
</p>
<p>
My PythonInterface::Initialise now looks like this:
</p>
<pre class="wiki">bool PythonInterface::Initialise()
{
	// Initialise Python.
	Py_Initialize();

	// Setup the Python search path.
	const char* python_path = Py_GetPath();
	char buffer[1024];
	snprintf(buffer, 1024, "../samples/invaders/python;%s", python_path);
	buffer[1023] = '\0';
	PySys_SetPath(buffer);

	// Import Rocket.
	if (!Import("rocket"))
		return false;

	return true;
}
</pre><p>
This will get us further, you should see the main menu load, however you'll notice a python error on your console when Python attempts to execute the old <i>onload</i> event in mainmenu.rml. Update the <i>onload</i> and <i>onunload</i> events to use Python script which will correctly display and hide the logo.
</p>
<pre class="wiki">&lt;body template="window" onload="document.context.LoadDocument('data/logo.rml').Show()" onunload="document.context.logo.Close()"&gt;
</pre><p>
You will now have to go through each event defined in RML updating it with equivalent Python calls.
</p>
<p>
RocketPython parses any semi-colons in an event as a delimiter. So you can place multiple Python statements on a single line, semi-colon separated. This comes in useful when you want to execute two statements at once, for example you probably want to do the following for the <i>Start Game</i> button.
</p>
<pre class="wiki">document.context.LoadDocument('data/start_game.rml').Show(); document.Close()
</pre><p>
I've simplified this further by by placing a LoadMenu function in the shared template window.rml, that loads a new document, closing the existing one.
</p>
<h2 id="Step3:ExposingGameFunctions">Step 3: Exposing Game Functions</h2>
<p>
The above takes care of most of the menu flow, except for a couple items, including the starting of the actual game and exiting. Lets tackle exiting first as that the easier of the two.
</p>
<p>
Our Python interface class will now have to expose a Python module (with the help of boost::python - <i>for full documentation see <a class="ext-link" href="http://www.boost.org"><span class="icon">http://www.boost.org</span></a></i>).
</p>
<pre class="wiki">BOOST_PYTHON_MODULE(game)
{
    python::def("Shutdown", &amp;Shell::RequestExit);
}
</pre><p>
This creates a module called <i>game</i> and places a <i>Shutdown</i> method within it. We now update the Initialise function to initialise this module at startup.
</p>
<pre class="wiki">bool PythonInterface::Initialise()
{
    // Initialise python
    Py_Initialize();

    // Setup the Python search path.
    const char* python_path = Py_GetPath();
    char buffer[1024];
    snprintf(buffer, 1024, "../samples/invaders/python;%s", python_path);
    buffer[1023] = '\0';
    PySys_SetPath(buffer);

    // Import rocket
    if (!Import("rocket"))
        return false;

    // Define our game specific interface
    initgame();

    return true;
}
</pre><p>
We can now call the <i>Shutdown</i> function from main_menu.rml as follows
</p>
<pre class="wiki">&lt;button onclick="import game;game.Shutdown()"&gt;Exit&lt;/button&gt;
</pre><p>
If you have a lot of functions that call game, you can place the <i>import game</i> in the document header, or in one of your template files.
</p>
<p>
Using the above code we can extrapolate this throughout the game and have a complete functioning menu system. You will however need to expose more of the GameDetails class to Python so that the <i>start_game</i> screen can save the difficulty and colour selection.
</p>
<p>
Your game module should look something like this:
</p>
<pre class="wiki">BOOST_PYTHON_MODULE(game)
{
    python::def("Shutdown", &amp;Shell::RequestExit);
    python::def("SetPaused", &amp;GameDetails::SetPaused);
    python::def("SetDifficulty", &amp;GameDetails::SetDifficulty);
    python::def("SetDefenderColour", &amp;GameDetails::SetDefenderColour);

    python::enum_&lt;GameDetails::Difficulty&gt;("difficulty")
        .value("HARD", GameDetails::HARD)
        .value("EASY", GameDetails::EASY)
    ;
}
</pre><h2 id="Step4:CustomElements">Step 4: Custom Elements</h2>
<p>
The next problem we'll hit when converting <i>RocketInvaders</i> is the ElementGame does not have a Python interface. Thus we can't give it focus when we start the game which means the defender cannot be moved until the user clicks the game with the mouse. To fix this, we need to define ElementGame to Python and register the Python instancer with Rocket::Factory instead of the C++ instancer.
</p>
<p>
Lets define a static method on ElementGame to do this and call it from our game modules initialisation.
</p>
<pre class="wiki">void ElementGame::InitialisePythonInterface()
{
    PyObject* object = python::class_&lt;ElementGame, 
                                      Rocket::Core::Python::ElementWrapper&lt;ElementGame&gt;,
                                      python::bases&lt;Rocket::Core::Element&gt;, 
                                      boost::noncopyable &gt;("ElementGame", python::init&lt;const char*&gt;())
    .ptr();

    Rocket::Core::Factory::RegisterElementInstancer("game", 
                                                    new Rocket::Core::Python::ElementInstancer(object))-&gt;RemoveReference();
}
</pre><h2 id="Step5:Keyandendgamebindings">Step 5: Key and end game bindings</h2>
<p>
We can now get into the game, however the game will never finish as theres no key bindings for processing the ESCAPE key and nothing will make the game exit when the game is over. Fixing the key binding is easy, simply drop in a OnKeyDown handler and make it launch the pause menu.
</p>
<p>
OnGameOver is a bit more tricky, as the old Invaders would call EventManager::LoadWindow directly from C++. We're going to have to add a game_over flag to game and make the GameElement check this state every update and fire a custom OnGameOver event.
</p>
<pre class="wiki">// Updates the game.
void ElementGame::OnUpdate()
{
	game-&gt;Update();

	if (game-&gt;IsGameOver())
		DispatchEvent("gameover", EMP::Core::Dictionary(), false);
}
</pre><h2 id="Step6:PythonDataFormatters">Step 6: Python Data Formatters</h2>
<p>
We're still using C++ data formatters, these can be moved into python for simplicity.
</p>
<pre class="wiki">class NameDataFormatter(rocket.DataFormatter):
    def __init__(self):
        rocket.DataFormatter.__init__(self, "name")
		
    def FormatData(self, raw_data):
	""" 
        Data format:
        raw_data[0] is the name.
        raw_data[1] is a bool - True means the name has to be entered. False means the name has been entered already.
        """
		
        formatted_data = ""

        if (raw_data[1] == "1"):
            formatted_data = "&lt;input id=\"player_input\" type=\"text\" name=\"name\" onchange=\"game.SetHighScoreName(event.value)\" /&gt;"
        else:
            formatted_data = raw_data[0]
			
        return formatted_data
</pre><p>
A lot more code could be moved from C++ into Python, for example the HighScore system. Its just a matter of taking the principles you have learnt here and applying them.
</p>
</div>
</div>
<script type="text/javascript">
   addHeadingLinks(document.getElementById("searchable"), "Link to this section");
  </script>
</div>
</div>
</div>
<div id="footer">
<a id="tracpowered" href="http://trac.edgewall.org/">
<img src="../../../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered"/>
</a>
<p class="left">
Powered by <a href="http://librocket.com/about"><strong>Trac </strong></a><br/>By <a href="http://www.edgewall.org/">Edgewall Software</a>.
</p>
<p id="copyright" class="left clear">
Copyright &copy; 2007-2010 Code Point Ltd, Shift Technology Ltd.
</p>
<ul class="top-level-nav">
<li><a href="../../frontend/features.html">features.</a></li>
<li><a "http://librocket.com/wiki/documentation/tutorials/href">download.</a></li>
<li><a href="http://forums.librocket.com">forums.</a></li>
<li><a href="../../documentation.html">developer.</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
<script type="text/javascript">
    var pageTracker = _gat._getTracker("UA-3379591-1");
    pageTracker._initData();
    pageTracker._trackPageview();
    </script>
</body>
</html>
